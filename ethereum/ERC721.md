# ERC721
OpenZeppelinã®ERC721ã‚’åˆ©ç”¨ã—ãŸãƒˆãƒ¼ã‚¯ãƒ³é–“ã§ã®é€é‡‘ã‚’è¡Œã†ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ

## ERC721ã®ä»•æ§˜
[ERC-721: Token Standard](https://eips.ethereum.org/EIPS/eip-721)

## hardhatãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
- ERC721ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
```
cd ~/hardhat
mkdir erc721
cd erc721
```

- hardhatã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```
npm init
npm install --save-dev hardhat
```

- hardhatã®åˆæœŸåŒ–
```
npx hardhat init
```

- Create a JavaScript project ã‚’é¸æŠ
- ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã®å‰Šé™¤
```
rm contracts/Lock.sol
rm test/Lock.js
```

## OpenZeppelinã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
```
npm install --save-dev @openzeppelin/contracts
```

## ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ä½œæˆ
`MusicNFT.sol`ã¨ã„ã†åã§ä½œæˆ

```
nano contracts/MusicNFT.sol
```

```solidity
// SPDX-License-Identifier: MIT
// Compatible with OpenZeppelin Contracts ^5.0.0
pragma solidity ^0.8.22;

import {ERC721} from "@openzeppelin/contracts/token/ERC721/ERC721.sol";
import {ERC721Burnable} from "@openzeppelin/contracts/token/ERC721/extensions/ERC721Burnable.sol";
import {ERC721Enumerable} from "@openzeppelin/contracts/token/ERC721/extensions/ERC721Enumerable.sol";
import {ERC721URIStorage} from "@openzeppelin/contracts/token/ERC721/extensions/ERC721URIStorage.sol";
import {Ownable} from "@openzeppelin/contracts/access/Ownable.sol";

contract MusicNFT is ERC721, ERC721Enumerable, ERC721URIStorage, ERC721Burnable, Ownable {
    uint256 private _nextTokenId;

    constructor(address initialOwner)
        ERC721("MusicNFT", "MFT")
        Ownable(initialOwner)
    {}

    // NFTã‚’æ–°è¦ç™ºè¡Œï¼ˆãƒŸãƒ³ãƒˆï¼‰ã™ã‚‹é–¢æ•°
    // onlyOwnerä¿®é£¾å­ã«ã‚ˆã‚Šã€ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®æ‰€æœ‰è€…ã®ã¿ãŒå®Ÿè¡Œå¯èƒ½
    function safeMint(address to, string memory uri) public onlyOwner {
        uint256 tokenId = _nextTokenId++;
        _safeMint(to, tokenId);
        _setTokenURI(tokenId, uri);
    }

    // The following functions are overrides required by Solidity.

    // ãƒˆãƒ¼ã‚¯ãƒ³ã®æ›´æ–°ï¼ˆè»¢é€ãªã©ï¼‰æ™‚ã®å‡¦ç†
    function _update(address to, uint256 tokenId, address auth)
        internal
        override(ERC721, ERC721Enumerable)
        returns (address)
    {
        return super._update(to, tokenId, auth);
    }

    // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®æ®‹é«˜ã‚’å¢—ã‚„ã™éš›ã®å‡¦ç†
    function _increaseBalance(address account, uint128 value)
        internal
        override(ERC721, ERC721Enumerable)
    {
        super._increaseBalance(account, value);
    }

    // ãƒˆãƒ¼ã‚¯ãƒ³ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿URIã‚’å–å¾—ã™ã‚‹é–¢æ•°
    function tokenURI(uint256 tokenId)
        public
        view
        override(ERC721, ERC721URIStorage)
        returns (string memory)
    {
        return super.tokenURI(tokenId);
    }

    // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã®ã‚µãƒãƒ¼ãƒˆçŠ¶æ³ã‚’ç¢ºèªã™ã‚‹é–¢æ•°
    function supportsInterface(bytes4 interfaceId)
        public
        view
        override(ERC721, ERC721Enumerable, ERC721URIStorage)
        returns (bool)
    {
        return super.supportsInterface(interfaceId);
    }
}
```

## ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«
```
npx hardhat compile
```

## ãƒ†ã‚¹ãƒˆã®ä½œæˆ
```
nano test/MusicNFT.js
```

```js
// hardhat tool box ã®åˆ©ç”¨
const {loadFixture} = require("@nomicfoundation/hardhat-toolbox/network-helpers");
// CHaiã®åˆ©ç”¨
const { expect } = require("chai");

describe("MusicNFTã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ", function () {
    async function deployMusicNFTFixture() {
        // ãƒ†ã‚¹ãƒˆç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å–å¾—
        const [owner, addr1, addr2] = await ethers.getSigners();
        // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹
        const MusicNFT = await ethers.deployContract("MusicNFT",[owner]);
        await MusicNFT.waitForDeployment();
        // MusicNFTãƒ†ã‚¹ãƒˆç”¨ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£
        return {MusicNFT, owner, addr1, addr2};
    }

    it("éŸ³æ¥½å®¶ addr1 ã®éŸ³æº music1 ã® MusicNFTã®ç”Ÿæˆ", async function () {
        // MusicNFTãƒ†ã‚¹ãƒˆç”¨ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
        const {MusicNFT, owner, addr1} = await loadFixture(deployMusicNFTFixture);
        let uri1 = "https://music.example/music-0.json";
        
        // ownerã‹ã‚‰ãƒŸãƒ³ãƒˆ
        const mintTX = await MusicNFT.safeMint(addr1.address, uri1);
        await mintTX.wait();

        expect(await MusicNFT.balanceOf(addr1)).to.equal(1);
    });

    it("NFTã®æ‰€æœ‰ã®ç§»è»¢", async function () {
        // MusicNFTãƒ†ã‚¹ãƒˆç”¨ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
        const {MusicNFT, owner, addr1, addr2} = await loadFixture(deployMusicNFTFixture);
        let uri1 = `https://music.example/music-0.json`;
    
        const mintTX = await MusicNFT.safeMint(addr1.address, uri1);
        await mintTX.wait();

        // ç§»è»¢å‰ã®æ‰€æœ‰è€…ã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        console.log("ç§»è»¢å‰ã®æ‰€æœ‰è€…:", await MusicNFT.ownerOf(0));

        // addr1 ã‹ã‚‰ã®æŒ‡ç¤ºã§ï¼Œaddr1 ã‹ã‚‰ addr2 ã«NFTã®æ‰€æœ‰ã‚’ç§»è»¢ã™ã‚‹
        const transferTx = await MusicNFT.connect(addr1).safeTransferFrom(addr1.address, addr2.address, 0);
        await transferTx.wait();

        // ç§»è»¢å¾Œã®æ‰€æœ‰è€…ã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        console.log("ç§»è»¢å¾Œã®æ‰€æœ‰è€…:", await MusicNFT.ownerOf(0));

        expect(await MusicNFT.ownerOf(0)).to.equal(addr2.address);
    });

    it("ç‰¹å®šã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæ‰€æœ‰ã™ã‚‹NFT", async function () {
        // MusicNFTãƒ†ã‚¹ãƒˆç”¨ãƒ•ã‚£ã‚¯ã‚¹ãƒãƒ£ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
        const {MusicNFT, owner, addr1, addr2} = await loadFixture(deployMusicNFTFixture);
        let uri1 = `https://music.example/music-0.json`;

        const mint1 = await MusicNFT.safeMint(addr1.address, uri1);
        await mint1.wait();
        
        const mint2 = await MusicNFT.safeMint(addr2.address, uri1);
        await mint2.wait();
        
        const mint3 = await MusicNFT.safeMint(addr1.address, uri1);
        await mint3.wait();

        // æ‰€æœ‰è€…ã®ãƒˆãƒ¼ã‚¯ãƒ³æ•°ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        console.log("addr1ã®æ‰€æœ‰ãƒˆãƒ¼ã‚¯ãƒ³æ•°:", await MusicNFT.balanceOf(addr1.address));

        // addr1 ãŒæ‰€æœ‰ã™ã‚‹NFTã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹1 ã® tokenID ã¯ 2n
        const tokenID = await MusicNFT.tokenOfOwnerByIndex(addr1.address, 1);
        expect(tokenID).to.equal(2n);
    });
});
```

### testã®å®Ÿè¡Œ
```
npx hardhat test

  MusicNFTã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆ
    âœ” éŸ³æ¥½å®¶ addr1 ã®éŸ³æº music1 ã® MusicNFTã®ç”Ÿæˆ (22113ms)
ç§»è»¢å‰ã®æ‰€æœ‰è€…: 0x70997970C51812dc3A010C7d01b50e0d17dc79C8
ç§»è»¢å¾Œã®æ‰€æœ‰è€…: 0x3C44CdDdB6a900fa2b585dd299e03d12FA4293BC
    âœ” NFTã®æ‰€æœ‰ã®ç§»è»¢ (19178ms)
addr1ã®æ‰€æœ‰ãƒˆãƒ¼ã‚¯ãƒ³æ•°: 2n
    âœ” ç‰¹å®šã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒæ‰€æœ‰ã™ã‚‹NFT (30085ms)


  3 passing (1m)
```

## hardhat node ã®èµ·å‹•
### hardhatè¨­å®šãƒ•ã‚¡ã‚¤ãƒ« hardhat.config.js ã®ä¿®æ­£
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ hardhat networkã«ã™ã‚‹
- ãƒã‚§ã‚¤ãƒ³IDã‚’ 31337
- ãƒã‚¤ãƒ‹ãƒ³ã‚°ã®é–“éš”ã‚’10ç§’ã«è¨­å®š

```
nano hardhat.config.js
```
```
require("@nomicfoundation/hardhat-toolbox");

/** @type import('hardhat/config').HardhatUserConfig */
module.exports = {
  solidity: "0.8.27",
  networks: {
    hardhat: {
      chainId: 31337,
      mining: {
        auto: false,
        interval: [10000, 11000]
      }
    },
  },
};
```

### ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ãƒ‰ã®èµ·å‹•
æ–°ã—ãç«¯æœ«ã‚’é–‹ã„ã¦å®Ÿè¡Œ
```
npx hardhat node
```

## ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½œæˆ

```
nano ignition/modules/MusicNFT.js
```

```js
const { buildModule } = require("@nomicfoundation/hardhat-ignition/modules");

// ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«å MusicNFT
module.exports = buildModule("MusicNFT", (m) => {
  // ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆå MusicNFT
  const contract = m.contract("MusicNFT", [owner]);
  
  return { contract };
});
```

### ãƒ­ãƒ¼ã‚«ãƒ«ãƒãƒ¼ãƒ‰ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤
```
npx hardhat ignition deploy ignition/modules/MusicNFT.js --network localhost

=>
Hardhat Ignition ğŸš€

Deploying [ MusicNFT ]

Batch #1
  Executed MusicNFT#MusicNFT

[ MusicNFT ] successfully deployed ğŸš€

Deployed Addresses

MusicNFT#MusicNFT - 0x5FbDB2315678afecb367f032d93F642f64180aa3
```


## ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã®æ“ä½œ

### ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®èµ·å‹•
```
npx hardhat console --network localhost 
```

### ERC721ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã¸ã®æ“ä½œ
```
const MusicNFT_addr = "0x5FbDB2315678afecb367f032d93F642f64180aa3"
const MusicNFT_Factory = await ethers.getContractFactory("MusicNFT")
const MusicNFT = await MusicNFT_Factory.attach(MusicNFT_addr)

// ãƒ†ã‚¹ãƒˆç”¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ
> const [owner, addr1, addr2] = await ethers.getSigners();
// æ–°ã—ã„éŸ³æºNFTã®æ¡æ˜
> await MusicNFT.safeMint(addr1, "https://music.example/music1.json")
// tokenID 0 ã®æ‰€æœ‰è€…ã®ã‚¢ãƒ‰ãƒ¬ã‚¹
> await MusicNFT.ownerOf(0)
=>
'0x70997970C51812dc3A010C7d01b50e0d17dc79C8'
// tokenID 0 ã®ãƒˆãƒ¼ã‚¯ãƒ³URI
> await const filter = contract.filters.EVENT_NAME( ...args ) .tokenURI(0)
=>
'https://music.example/https://music.example/music1.json'
// addr1 ãŒæ‰€æœ‰ã™ã‚‹NFTã‚’ addr2 ã«ç§»è»¢ã™ã‚‹
// connect ã§æ‰€æœ‰è€…ã«ã‚ˆã‚‹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®ç½²åã«ã™ã‚‹ã“ã¨ãŒå¿…è¦
> await MusicNFT.connect(addr1).safeTransferFrom(addr1.address, addr2.address, 0)
```

const mintTX = await MusicNFT.safeMint(addr1.address, "https://music.example/music1.json");
        await mintTX.wait();

const transferTx = await MusicNFT.connect(addr1).safeTransferFrom(addr1.address, addr2.address, 0);
        await transferTx.wait();


## MetaMaskã§ã®é€é‡‘
hardhat node ãŒåˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### ãƒˆãƒ¼ã‚¯ãƒ³ã®è¿½åŠ 
- ãƒ¡ã‚¿ãƒã‚¹ã‚¯ã§ã€Œãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ã‚’é¸æŠ


- å…ˆã»ã©ã®ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã™ã‚‹



- ãƒˆãƒ¼ã‚¯ãƒ³ãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆã•ã‚Œã‚‹




- åŒã˜æ‰‹é †ã§ç§»å‹•å…ˆã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«ã‚‚ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹




### ä»–ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ã®ãƒˆãƒ¼ã‚¯ãƒ³ã®é€é‡‘
- é€é‡‘ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã®ã¡ã€ç§»å‹•å…ƒã¨ç§»å‹•å…ˆã‚’é¸æŠ
- ä»Šå›ã¯100ãƒˆãƒ¼ã‚¯ãƒ³é€é‡‘
- **ç¶šè¡Œ**ã‚’é¸æŠ



- **ç¢ºèª**ã‚’é¸æŠ


